<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title></title><meta charset="UTF-8"></meta><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="hovercraft.css" media="screen,projection"></link><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        TeX : { extensions : ['color.js'] }
      });
    </script></head><body class="impress-not-supported"><div id="impress"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="writing-rust-for-run">Writing Rust for Run</h1><h2 id="profit">(&amp; Profit?)</h2><a href="http://www.rustacean.net/"><img src="images/rustacean-orig-trans.png" alt="[Rustacean]" width="50%" class="rustacean"></img></a><p>Presenter: Mark Lee, Pythonista, Sometimes-Rubyist, and Novice Rustacean</p><p>February 19, 2016</p><div class="notes"><p>Today I'm going to go through an overview of the Rust programming language and possible applications to our ecosystem, in the form of example use cases.</p></div></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><img src="images/rust-logo-512x512.png" alt="[Rust Logo]"></img><div class="notes"><p>Let's start with the question, "What is Rust?"</p></div></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="system-programming-language">System Programming Language</h1><ul><li>Low-level</li><li>No built-in JIT / garbage collector</li><li>Competes with C and C++</li></ul><div class="notes"><p>Rust is designed as a system programming language. Generally speaking, that means that it's low-level - if you want, you can even compile code to not use a system runtime. This is particularly useful if you are writing an operating system (and I'm aware of at least two projects that are doing so). There is also no built-in JIT or garbage collector, so it's more like C or C++ than a lot of other contemporary languages.</p></div></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="memory-safe">Memory Safe</h1><ul><li><strong>No</strong> <tt>malloc</tt> / <tt>free</tt></li><li><strong>No</strong> <tt>NULL</tt></li><li>Unsafe operations are delimited by <tt>unsafe { &#x2026; }</tt></li></ul><div class="notes"><p>The main reason why I like Rust is that unlike C or C++, it is memory safe by default. For me, this means two things: I don't have to worry about allocating and freeing memory manually, and I don't have to worry about the <tt>NULL</tt> case, because <tt>NULL</tt> doesn't exist. Well, that's not entirely true. If you know what you're doing, you can write "unsafe" code that uses one or both of memory allocation or NULLs if you wrap it in an <tt>unsafe</tt> block. As the Zen of Python says, "Explicit is better than implicit."</p></div></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="history">History</h1><ul><li>Started ~2010</li><li>Released 1.0 in May 2015</li><li>New version released every ~six weeks</li><li>Current version: 1.6</li></ul><div class="notes"><p>Rust is a relatively new language, started around six years ago. (For comparison, Python started around 1991, Ruby and PHP around 1995, Go in 2009.) Version 1.0 was released last May, and since then, a new stable version is released approximately every six weeks. It's currently at 1.6.</p></div></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="who-uses-it">Who Uses It?</h1><ul><li>Mozilla (<a href="https://servo.org/">Servo web browser engine</a>)</li><li><a href="https://github.com/twitter/rpc-perf">Twitter</a> (RPC performance tool)</li><li>Skylight.io (agent for web app performance app)</li><li>Dropbox (internal use - undisclosed)</li></ul><div class="notes"><p>There are several companies who are currently developing things in Rust. Mozilla's Servo web browser engine is probably the most well-known project, but Twitter recently released an RPC performance tool, Skylight's data gathering agent is all-Rust, and Dropbox uses it for an undisclosed reason.</p></div></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><h1 id="example">Example</h1><pre class="highlight code rust"><span class="ln"> 1 </span><span class="k">enum</span> <span class="nc">GreetingType</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="ln"> 2 </span><span class="w">    </span><span class="n">Friendly</span><span class="p">,</span><span class="w">
</span><span class="ln"> 3 </span><span class="w">    </span><span class="n">Unfriendly</span><span class="p">,</span><span class="w">
</span><span class="ln"> 4 </span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="ln"> 5 </span><span class="w">
</span><span class="ln"> 6 </span><span class="w"></span><span class="k">fn</span> <span class="nf">greeting</span><span class="p">(</span><span class="n">greeting_type</span>: <span class="nc">GreetingType</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span><span class="w">
</span><span class="ln"> 7 </span><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">greeting_type</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="ln"> 8 </span><span class="w">        </span><span class="n">GreetingType</span>::<span class="n">Friendly</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">"friend"</span><span class="p">,</span><span class="w">
</span><span class="ln"> 9 </span><span class="w">        </span><span class="n">GreetingType</span>::<span class="n">Unfriendly</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">"jerk"</span><span class="p">,</span><span class="w">
</span><span class="ln">10 </span><span class="w">    </span><span class="p">}.</span><span class="n">to_owned</span><span class="p">()</span><span class="w">
</span><span class="ln">11 </span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="ln">12 </span><span class="w">
</span><span class="ln">13 </span><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="ln">14 </span><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">chosen_greeting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">greeting</span><span class="p">(</span><span class="n">GreetingType</span>::<span class="n">Friendly</span><span class="p">);</span><span class="w">
</span><span class="ln">15 </span><span class="w">  </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Hello, {}!"</span><span class="p">,</span><span class="w"> </span><span class="n">chosen_greeting</span><span class="p">)</span><span class="w">
</span><span class="ln">16 </span><span class="w"></span><span class="p">}</span></pre><img src="images/example-output.png" alt="[Compiling and running the example]"></img><div class="notes"><p>Here's an example of Rust code that's slightly better than a 3 line "hello, world!" program. In particular, it shows off three features of Rust. First, in <tt>main</tt>, you'll note that <tt>chosen_greeting</tt> doesn't have a type explicitly named. By and large, Rust uses type inference to determine variable types at declaration time. Second, instead of switch-case, there's the match statement. Match statements will not compile if you don't take into account all possible values of the type that you're matching, but there is still a catch-all syntax. Third, if you look at the console screenshot, you'll see that the Rust compiler emits a warning that we haven't used the <tt>Unfriendly</tt> value. You'd likely also see this sort of warning in modern C compilers, but the warning message itself would be a bit more esoteric, and you might not get the ASCII arrow.</p></div></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="id1">?</h1><div class="notes"><p>Now, an example of a shiny new programming language is all well and good, but how does it help us?
There are two possible answers that I have explored.</p></div></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="use-case-function-speedup-via-ruby-extension">Use Case: Function Speedup via Ruby Extension</h1><div class="notes"><p>The first use case I actually did most of the research almost a year ago, here at work. I was in the middle of my "refactor ETL" project and I was experimenting with extracting the data into PostgreSQL. My thought was to use HSTORE, to avoid column changes when the data layout changed. (This was before we had access to a Postgres database with 9.4 installed, otherwise I would have chosen JSONB first.) The problem was that when I profiled it with a significant number of records, the ActiveRecord implementation of serializing data into HSTORE SQL was a fairly big bottleneck. I really didn't want to write a pure C extension to deal with this, and I had read about Rust, so I decided to take about a day and see if I would write it.</p></div></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="benchmarks">Benchmarks</h1><table cellpadding="0" cellspacing="0"><tbody><tr><td><p><strong>Rails</strong></p></td><td><p>0.524416</p></td><td><p>0.508318</p></td><td><p>0.514101</p></td><td><p>0.509216</p></td><td><p>0.512424</p></td></tr><tr><td><p><strong>Rust</strong></p></td><td><p>0.322545</p></td><td><p>0.311844</p></td><td><p>0.313411</p></td><td><p>0.310076</p></td><td><p>0.313621</p></td></tr></tbody></table><p>~40% speedup</p><div class="notes"><p>The result was that I got something working, and it was somewhat faster than the pure Ruby version, but it was using the nightly version of Rust (1.0 was not out at the time), it was partly written in C (as the glue between Rust and Ruby), and I ran into other problems with HSTORE orthogonal to the extension, so it was put aside. After this experiment, it took me two more tries within the past year to get it working a) noticeably faster, and b) using a stable compiler. Last week, I finally got it working (and fixed a memory leak in the C code in the process). If I were to put some more work into it, I would try to figure out how to utilize this library named turboruby, written by the Skylight developers. It contains Rust bindings to Ruby's extension API, which would avoid me having to write C, though I'm not sure whether it would have necessarily solved the memory leak problem. I wouldn't be surprised if I would have to write unsafe code.</p></div></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="use-case-web-app">Use Case: Web App</h1><div class="notes"><p>The second case I'm going to present is a small web app that I made in the past week.</p></div></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><img src="images/pair-of-commits.png"></img><div class="notes"><p>The impetus was a pair of commits I saw. I think at this point, most of the people in the room have either cursed at or heard a coworker curse at the fact that the Heroku Ruby buildpack's Bundler version is incompatible with the latest version, and prevents new deploys for Heroku apps unless you fix your Gemfile. I thought, wouldn't it be great to have a website that checks if the latest released buildpack had a compatible Bundler version?</p></div></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19200" data-y="0" data-z="0"><a href="https://hasbuildpackbundlerupgradedyet.herokuapp.com/"><img src="images/hasbuildpackbundlerupgradedyet.png" alt="[Website screenshot: hasbuildpackbundlerupgradedyet]" width="100%"></img></a><div class="notes"><p>Four nights of coding later, I came up with this. It ultimately came down to ~200 lines of Rust code. But those ~200 lines were hand-crafted, artisan lines of code, forged by a lot of trial and error. Fortunately, I was pretty familiar with the leading HTTP library (named hyper), since I am in the middle of writing an HTTP authentication/authorization library (named guardhaus). I was not, however, familiar with the caching libraries available, so I originally started with a memcached backend, na&#xEF;vely assuming that it would "just work". I didn't count on the fact that it was non-trivial to implement authentication, which is required for memcached services on Heroku. I poked at it for a half hour, then decided to give up and switch to Redis, which probably turned out better anyway.</p></div></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20800" data-y="0" data-z="0"><h1 id="rust-vs-python">Rust vs. Python</h1><pre class="highlight code sh"><span class="k">for</span> i <span class="k">in</span> <span class="k">$(</span>seq <span class="m">1</span> <span class="m">10</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
  <span class="nb">time</span> curl -s -H <span class="s1">'Accept: application/json'</span> localhost:9000 &gt; /dev/null
<span class="k">done</span></pre><table cellpadding="0" cellspacing="0"><thead><tr><th><p>Type</p></th><th><p>Rust</p></th><th><p>Python</p></th></tr></thead><tbody><tr><td><p><strong>Source Lines of Code</strong></p></td><td><p>205</p></td><td><p>87</p></td></tr><tr><td><p><strong>Average request time</strong></p></td><td><p>0.0146s</p></td><td><p>0.1744s</p></td></tr></tbody></table><div class="notes"><p>For comparison purposes, I took an evening and wrote an equivalent implementation with Python3. I performed very simple <tt>curl</tt> based benchmarks on the two implementations on my laptop, and the result was, for about 2.5 times the amount of code, the Rust app performed over 10 times as quickly as the Python implementation. Which is not too surprising.</p></div></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22400" data-y="0" data-z="0"><p>Phase 1: Collect Underpants^WBusiness Data</p><p>Phase 2: ?</p><p>Phase 3: Profit</p><div class="notes"><p>Ultimately, my conclusion is that Rust is at a point where we should have the discussion as to
whether this is the language that we choose to use to speed parts of our system up. It was not
the case when I first looked at it a year ago, but its commitment to language stability and
steadily maturing ecosystem make it a real contender now.</p></div></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="0" data-z="0"><h1 id="questions">Questions?</h1></div></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/gotoSlide.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>